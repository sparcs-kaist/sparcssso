{% extends "base.html" %}

{% load i18n %}

{% block app-header %}

<link rel="stylesheet" type="text/css" href="/static/css/main.css">

<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/locales/bootstrap-datepicker.ko.min.js"></script>

<link rel="stylesheet" type="text/css" href="http://nvd3.org/assets/css/nv.d3.css">
<script src="http://nvd3.org/assets/lib/d3.v3.js"></script>
<script src="http://nvd3.org/assets/js/nv.d3.js"></script>
<script src="http://nvd3.org/assets/js/data/stream_layers.js"></script>

{% endblock %}

{% block content %}
<style>
    .chart-header {
        float: left;
        font-weight: 600;
        margin: 10px;
    }

    .top-panel {
        width: 60%;
        margin: 0 auto;
    }

    .input-daterange {
    }
</style>

<h1 class="doc-header">SPARCS SSO Statistics <small>({{ time|date:"Y-m-d\TH:i:sT"}})</small></h1>
<p>Permission: 
{% if level == 0 %}
PUBLIC
{% elif level == 1 %}
<b>SPARCS</b>
{% elif level == 2 %}
<span class="text-danger"><b>SYSOP</b></span>
{% endif %}
</p>

<div class="row">
    <div class="input-daterange input-group top-panel" id="datepicker">
        <div class="input-group-btn btn-group" role="group">
            <div class="btn-group" role="group">
                <button class="btn btn-default dropdown-toggle" type="button" id="service-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span class="s-name">서비스</span>
                    <span class="caret"></span>
                </button>
                <ul id="service-dropdown-menu" class="dropdown-menu" aria-labelledby="service-dropdown">
                </ul>
            </div>
        </div>
        <input type="text" class="form-control date-control s-date" name="start" value="" />
        <span class="input-group-addon">~</span>
        <input type="text" class="form-control date-control e-date" name="end" value="" />
        <span class="input-group-btn">
            <button class="btn btn-default btn-primary btn-get-stat" type="button">Go!</button>
        </span>
    </div>
</div>


<div class="row" style="margin-top: 30px;">
    
    <div class="chart-lv-1">
        <p class="chart-header">Birth_Year</p>
        <div>
            <svg id="birth-year-chart" style='width:100%; height:500px;'> </svg>
        </div>
    
        <p class="chart-header">Gender</p>
        <div>
            <svg id="gender-chart" style='width:100%; height:500px;'> </svg>
        </div>
    </div>
    
    <div class="chart-lv-2">
        <p class="chart-header">Account</p>
        <div>
            <svg id="account-chart" style='width:100%; height:500px;'> </svg>
        </div>
    
        <hr>
        <p class="chart-header">KAIST - Gender</p>
        <div>
            <svg id="kaist-gender-chart" style='width:100%; height:500px;'> </svg>
        </div>
    
        <p class="chart-header">KAIST - Start_Year</p>
        <div>
            <svg id="kaist-start-year-chart" style='width:100%; height:500px;'> </svg>
        </div>
    
        <p class="chart-header">KAIST - Birth_Year</p>
        <div>
            <svg id="kaist-birth-year-chart" style='width:100%; height:500px;'> </svg>
        </div>
    
        <p class="chart-header">KAIST - Department</p>
        <div>
            <svg id="kaist-department-chart" style='width:100%; height:500px;'> </svg>
        </div>
    </div>
</div>


<script>

var first_call_g = true;

/*
s_date_g: start date, manually
e_date_g: date of today
*/
var s_date_g = "2016-08-16"
var e_date_g = (new Date()).toISOString().substring(0, 10);
var service_g = "all"

$('.input-daterange').datepicker({
    autoclose: true,
    todayHighlight: true,
    format: "yyyy-mm-dd",    
});

$(document).ready(function(){
    set_date_to_calendar(s_date_g, e_date_g);
    get_stats(service_g, s_date_g, e_date_g);
    find_dropdown_menu_pos();
});

$(window).resize(function(){
    find_dropdown_menu_pos();        
});

$("body").on("click", ".dropdown-service", function(){
    service_g = $(this).text();
    change_service(service_g);   
});

$(".btn-get-stat").click(function(){
    s_date_g = $(".s-date").val();
    e_date_g = $(".e-date").val();
    get_stats(service_g, s_date_g, e_date_g);
});


/**
jquery ajax call
@param - read https://wiki.sparcs.org/w/index.php/SPARCS_SSO_API_%EB%AA%85%EC%84%B8
 */
function get_stats(client_ids, date_from, date_to){
    var param = {};
    var arg_names = ["client_ids", "date_from", "date_to"];
    for(var idx = 0; idx < arguments.length; idx++){
        param[arg_names[idx]] = arguments[idx];
    }
    $.ajax({
        url: "/api/v2/stats/",
        data: param,
        success: success_stats,
        dataType: "Json",
    });
}


/**
jquery ajax success function
 */
function success_stats(data, textStatus, jqXHR){
    var service_list = get_services(data);
    console.log(data);
    var s_data = get_data_of_s(data, service_list[0]);
    change_service(service_list[0]);
    destroy_not_auth_chart(s_data);

    /* only first call, add services to dropdown */
    if(first_call_g){
        add_services(service_list);
        first_call_g = false;
    }
    if(Object.keys(s_data).length != 0){
        var property_arr = get_properties(s_data);
        var property_kaist_arr = get_properties_kaist(s_data);
        for(var idx = 0; idx < property_arr.length; idx++){
            var property = property_arr[idx];
            
            formatted_data = get_formatted_data(s_data);

            if(property != "kaist"){ 
                var f_data = make_formatted_to_arr(
                    formatted_data[property]
                );
                draw_graph(f_data, property);
            } else{
                for(var kaidx in property_kaist_arr){
                    var property_kaist = property_kaist_arr[kaidx]
                    if(property_kaist != "department"){
                        var f_data = make_formatted_to_arr(
                            formatted_data[property][property_kaist]
                        );
                        draw_graph_kaist(f_data, property, property_kaist);
                    } else { /* departemnt case */
                        var f_data = formatted_data[property][property_kaist];
                        draw_graph_dept(f_data);
                    }
                }
            }
        }
    } else {
        // alert("선택한 구간의 데이터가 없습니다!");
    }
}

function change_service(s_name){
    $(".s-name").text(s_name);
}


/**
Graph drawing function
*/
function draw_graph(f_data, property){
    var property = property.replace("_", "-");
    nv.addGraph(function() {
        var chart = nv.models.multiBarChart()
            .transitionDuration(350)
            .reduceXTicks(true)   //If 'false', every single x-axis tick label will be rendered.
            .rotateLabels(0)      //Angle to rotate x-axis labels.
            .showControls(true)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
            .groupSpacing(0.1)    //Distance between each group of bars.
            ;

        chart.xAxis
            .tickFormat(function(d){
                return d3.time.format("%x")(new Date(d))
            });

        chart.yAxis
            .tickFormat(d3.format(',.0f'));

        d3.select("#"+property+"-chart")
            .datum(f_data)
            .call(chart);

        nv.utils.windowResize(chart.update);

        return chart;
    });
}

function draw_graph_kaist(f_data, property, property_2nd){
    var property = property.replace("_", "-");
    var property_2nd = property_2nd.replace("_", "-");
    var property_class = [property, property_2nd].join("-");
    draw_graph(f_data, property_class);
}

function draw_graph_dept(f_data) {
    nv.addGraph(function() {
        var chart = nv.models.pieChart()
            .x(function(d) { return d.label })
            .y(function(d) { return d.value })
            .showLabels(true)
            .labelThreshold(.05)
            .labelType("percent") 
            .donut(true)
            .donutRatio(0.35)
            .valueFormat(d3.format(',.0f'));

        d3.select("#kaist-department-chart")
            .datum(f_data)
            .transition().duration(350)
            .call(chart);
        
        return chart;
    }); 
}


/**
Stats object manipulation function
*/

/**
@param {obj} data - json object from stats api
@returns {array} - array of services
*/
function get_services(data){
    var stats = data["stats"];
    return Object.keys(stats);
}

function get_data_of_s(data, s_name){
    if(typeof(s_name) == "undefined"){
        return {};
    } else{
        return data["stats"][s_name]["data"];
    }
}

function get_properties(s_data){
    var date_arr = Object.keys(s_data);
    return Object.keys(s_data[date_arr[date_arr.length -1]]);
}

function get_properties_kaist(s_data) {
    var date_arr = Object.keys(s_data);
    return Object.keys(s_data[date_arr[date_arr.length -1]]["kaist"]);
}

/*
@param {obj} s_data - Data format
{
    2016-08-17T12:46:56+00:00: {
        account: {
            all: int_all,
            email: int_email,
            ...
        },
    },
    2016-08-18T12:55:35+00:00: {
        ...
    },
}
@returns {obj} - Data format
{
    property: {
        label1: {
            key: "label1",
            values:[
                { x1: val_x1, y1: val_y1},
                { x2: val_x2, y2: val_y2},
                ...
                ]
        }
    },
    kaist: {
        2nd_property: {
            label2: {
                key: "label2",
                ...
            }
        },
        department: [
            {label: "label", value: "value"},
        ]
    }   
}
*/

function get_formatted_data(s_data){
    
    var formatted_obj = {};
    var date_arr = Object.keys(s_data).sort();
    for(var idx = 0; idx < date_arr.length; idx++){
        var date_key = date_arr[idx];
        var attr_obj = s_data[date_key];
        
        for(var property in attr_obj){
            if(property != "kaist"){
                preprocess_data(attr_obj, property);
                for(var label in attr_obj[property]){
                    if(!is_valid_key_arr(formatted_obj, [property, label])){
                        formatted_obj = set_emt_to_obj(formatted_obj, [property, label], {
                            "key": label,
                            "values": []
                        })
                    }
                    formatted_obj[property][label]["values"]
                    .push({
                        "x": date_key,
                        "y": attr_obj[property][label]
                    });
                }
            } else{ /* kaist case */
                for(var property_2nd in attr_obj[property]){
                    var attr_2nd_obj = attr_obj[property][property_2nd];
                    
                    preprocess_data(attr_obj, property, property_2nd);
                    
                    if(property_2nd != "department"){
                        for(var label in attr_2nd_obj){
                            if(!is_valid_key_arr(formatted_obj, [property, property_2nd, label])){
                                formatted_obj = set_emt_to_obj(formatted_obj,
                                        [property, property_2nd, label], {
                                    "key": label,
                                    "values": []
                                })
                            }
                            formatted_obj[property][property_2nd][label]["values"]
                            .push({
                                "x": date_key,
                                "y": attr_2nd_obj[label]
                            });
                        }
                    } else { /* most recent department case */
                        if(idx == date_arr.length - 1){
                            if(!is_valid_key_arr(formatted_obj, [property, property_2nd])){
                                formatted_obj = set_emt_to_obj(formatted_obj,
                                    [property, property_2nd], []);
                            }
                            for(var code in attr_2nd_obj){
                                if(is_key(dept_data, code)){
                                    formatted_obj[property][property_2nd]
                                    .push({
                                        "label": dept_data[code],
                                        "value": attr_2nd_obj[code],
                                    });
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return formatted_obj;
}
/*
manipulate formatted_obj for purpose
- birth_year: append {year: 0} which api does not contain for spacing

@return: r_values
*/
function preprocess_data(attr_obj, property, property_2nd) {
    
    var p_attr_obj = attr_obj[property];
    
    switch(property){
        case "account":
            // delete p_attr_obj["all"];
            // now, api does not provide "all" case;
            break;
        case "birth_year":
            p_attr_obj = preprocess_data_birth_year(p_attr_obj);
            break;
        case "gender":
            break;
        case "kaist":
            /* 여기 구현 해야 함*/ 
            p_attr_obj = preprocess_data_kaist(p_attr_obj, property_2nd);
            break;
    }
    
}

/**
@param {obj} p_attr_obj - apijson["birth_year"]
- append {year: 0} which api does not contain for spacing
@return preprocessed p_attr_obj
*/
function preprocess_data_birth_year(p_attr_obj){
    date_arr = Object.keys(p_attr_obj);
    min_date = min(date_arr);
    max_date = max(date_arr);
    for(var d = min_date; d <= max_date; d++){
        if(date_arr.indexOf(d+"") === -1){
            p_attr_obj[d] = 0;
        }
    }
    return p_attr_obj;
}

/**
parsing json["kaist"] to 2nd-depth
@param {obj} p_attr_obj - apijson["kaist"]
@param {string} property_2nd - birth_year, department, employee, gender, professor, start_year
@return preprocessed p_attr_obj;
*/
function preprocess_data_kaist(p_attr_obj, property_2nd){
    var p2nd_attr_obj = p_attr_obj[property_2nd];
    switch(property_2nd){
        case "birth_year":
            preprocess_data_birth_year(p2nd_attr_obj);
            break;
        case "department":
            break;
        case "start_year":
            break;
        case "gender":
            break;
    }
}


/**
DOM manipulation function with jquery
*/
function add_services(service){
    for(var idx = 0; idx < service.length; idx++){
        $("#service-dropdown-menu").append('<li id=dropdown-'+service[idx]+' class="dropdown-service"  ><a href="#">'+service[idx]+'</a></li>');
    }
}

function find_dropdown_menu_pos(){
    $dm_left = $("#service-dropdown").position();
    $("#service-dropdown-menu").css("left", $dm_left.left);
}

function set_date_to_calendar(s_date, e_date){
    $(".s-date").val(s_date);
    $(".e-date").val(e_date);
}

function destroy_not_auth_chart(s_data){
    var len = Object.keys(s_data).length;
    if(len == 0){
        $(".chart-lv-1").remove();
        $(".chart-lv-2").remove();
    } else if (len < 3){
        $(".chart-lv-2").remove();
    }
}


/*
Help function
*/
function min(x /*: Array<number> */)/*:number*/ {
    var value;
    for (var i = 0; i < x.length; i++) {
        if (value === undefined || x[i] < value) {
            value = x[i];
        }
    }
    if (value === undefined) {
        return NaN;
    }
    return value;
}

function max(x /*: Array<number> */) /*:number*/ {
    var value;
    for (var i = 0; i < x.length; i++) {
        if (value === undefined || x[i] > value) {
            value = x[i];
        }
    }
    if (value === undefined) {
        return NaN;
    }
    return value;
}

function is_valid_key_arr(obj, key_arr){
    for(var idx in key_arr){
        var key = key_arr[idx];
        if(Object.keys(obj).indexOf(key) != -1){
            var obj = obj[key];
        } else {
            return false;
        }
    }
    return true;
}

function set_emt_to_obj(obj, key_arr, value){
    var copied_obj = JSON.parse(JSON.stringify(obj));  
    if(key_arr.length == 1){
        var key = key_arr[0];
        copied_obj[key] = value;
    } else {
        var key = key_arr.shift();
        if(!is_key(copied_obj, key)){
            copied_obj[key] = {};
        }
        var new_obj = copied_obj[key]; 
        copied_obj[key] = set_emt_to_obj(new_obj, key_arr, value);
    }
    return copied_obj;
}

function is_key(obj, key){
    return (Object.keys(obj).indexOf(key+"") != -1);
}

function make_formatted_to_arr(formatted_obj){
    var r_arr = [];
    for(var label in formatted_obj){
        r_arr.push(formatted_obj[label]);
    }
    return r_arr;
}

/* global data */
var dept_data = {
    0: 'Undecided',
    3648: 'Bio and Brain Engineering',
    132: 'Biological Sciences',
    2222: 'Biomedical Science and Engineering Program',
    936: 'Business',
    33: 'Capstone Design',
    451: 'Chemical and Biomolecular Engineering',
    150: 'Chemistry',
    441: 'Civil and Environmental Engineering',
    4419: 'Departmemt of Aerospace Engineering',
    4418: 'Departmemt of Mechanical Engineering',
    331: 'Department of Industrial Systems Engineering',
    151: 'Department of Mathematical Sciences',
    3992: 'Division of Future Vehicle',
    4201: 'Economics Program',
    4431: 'Entrepreneurship Program',
    4305: 'Executive MBA',
    4398: 'Finance Executive MBA',
    4303: 'Finance MBA',
    3919: 'Financial Engineering Program',
    4310: 'Financial Engineering Program',
    973: 'General Required',
    3941: 'Global Information &amp; Telecommunication Technology Program',
    4200: 'Graduate Program for Future Strategy',
    3539: 'Graduate School of Culture Technology',
    4144: 'Graduate School of Information Security',
    4438: 'Graduate School of Innovation & Technology Management',
    4549: 'Graduate School of Knowledge Service Engineering',
    3605: 'Graduate School of Medical Science and Engineering',
    3990: 'Graduate School of Science and Technology Policy',
    4422: 'Graduate School of Web Science Technology',
    3799: 'Graduate school of EEWS',
    3692: 'Graduate school of Nanoscience &amp; Technology',
    4493: 'Green Business and Policy Program',
    340: 'Industrial Design',
    4312: 'Information Management Program',
    3723: 'Information and Communications Engineering',
    4306: 'Information and Media MBA',
    3978: 'Intellectual Property Minor Program for Undergradu',
    3920: 'Master of Science Journalism',
    3882: 'Master of intellectual property',
    421: 'Materials Science and Engineering',
    4141: 'Minor Program in Culture Technology',
    3993: 'Minor Program in Science and Technology Policy',
    4425: 'Moon Soul Graduate School of Future Strategy',
    221: 'Nuclear and Quantum Engineering',
    110: 'Physics',
    2410: 'Polymer Science and Engineering Program',
    4182: 'Professional MBA',
    4427: 'Program of Brain and Cognitive Engineering',
    4547: 'School of Business and Technology Management',
    4548: 'School of Business and Technology Management',
    4421: 'School of Computing',
    4423: 'School of Electrical Engineering',
    4424: 'School of Humanities &amp; Social Sciences',
    4301: 'School of Management Engineering',
    4183: 'Social Entrepreneurship MBA',
    3703: 'Software Graduate Program',
    3701: 'Space Exploration Engineering Program',
    4307: 'Techno-MBA',
    3997: 'The Cho Chun Shik Graduate School for Green Transportation',
    3520: 'The Robotics Program',
    4: 'Undergraduate Research Participation',
};

</script>

{% endblock %}
