{% extends "base.html" %}
<style>
</style>
{% load i18n %}

{% block app-header %}
<!--
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css">
-->
<link rel="stylesheet" type="text/css" href="/static/css/main.css">

<link rel="stylesheet" type="text/css" href="http://nvd3.org/assets/css/nv.d3.css">
<script src="http://nvd3.org/assets/lib/d3.v3.js"></script>
<script src="http://nvd3.org/assets/js/nv.d3.js"></script>
<script src="http://nvd3.org/assets/js/data/stream_layers.js"></script>

{% endblock %}

{% block content %}
<h1 class="doc-header">SPARCS SSO Statistics <small>({{ time|date:"Y-m-d\TH:i:sT"}})</small></h1>
<p>Permission: 
{% if level == 0 %}
PUBLIC
{% elif level == 1 %}
<b>SPARCS</b>
{% elif level == 2 %}
<span class="text-danger"><b>SYSOP</b></span>
{% endif %}
</p>

<div class="row">

	<div class="dropdown">
		<button class="btn btn-default dropdown-toggle" type="button" id="service-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
			서비스 선택
			<span class="caret"></span>
		</button>
		<ul id="service-dropdown-menu" class="dropdown-menu" aria-labelledby="service-dropdown">
		</ul>
	</div>
	
	<div>
		<svg id="account-chart" style='width:100%; height:500px;'> </svg>
	</div>	
	<div>
		<svg id="birth-year-chart" style='width:100%; height:500px;'> </svg>
	</div>
	<div>
		<svg id="gender-chart" style='width:100%; height:500px;'> </svg>
	</div>
</div>

<script>
/**
test code
*/
get_stats("all", "2016-08-16");

$(document).ready(function(){
	find_dropdown_menu_pos();
});

$(window).resize(function(){
	find_dropdown_menu_pos();		
});


/**
jquery ajax call
@param - read https://wiki.sparcs.org/w/index.php/SPARCS_SSO_API_%EB%AA%85%EC%84%B8
 */
function get_stats(client_ids, date_from, date_to){
	var param = {};
	var arg_names = ["client_ids", "date_from", "date_to"];
	for(var idx = 0; idx < arguments.length; idx++){
		param[arg_names[idx]] = arguments[idx];
	}
	$.ajax({
		url: "/api/v2/stats/",
		data: param,
		success: success_stats,
		dataType: "Json",
	});
}

/**
jquery ajax success function
 */
function success_stats(data, textStatus, jqXHR){
	var service = get_services(data);
	var s_data = get_data_of_s(data, "otlplus")
	add_services(service);
	
	var property_arr = ["account", "birth_year", "gender"];
	for(var idx = 0; idx < property_arr.length; idx++){
		var property = property_arr[idx];
		var f_data = get_formatted_data(s_data, property);
		draw_graph(f_data, property);
	}
}

/**
Graph drawing function
*/
function draw_graph(f_data, property){
	var property = property.replace("_", "-");
	nv.addGraph(function() {
		var chart = nv.models.multiBarChart()
			.transitionDuration(350)
			.reduceXTicks(true)   //If 'false', every single x-axis tick label will be rendered.
			.rotateLabels(0)      //Angle to rotate x-axis labels.
			.showControls(true)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
			.groupSpacing(0.1)    //Distance between each group of bars.
			;

		chart.xAxis
			.tickFormat(function(d){
				return d3.time.format("%x")(new Date(d))
			});

		chart.yAxis
			.tickFormat(d3.format(',.1f'));

		d3.select("#"+property+"-chart")
			.datum(f_data)
			.call(chart);

		nv.utils.windowResize(chart.update);

		return chart;
	});
}


/**
Stats object manipulation function
*/

/**
@param {obj} data - json object from stats api
@returns {array} - array of services
*/
function get_services(data){
	var stats = data["stats"];
	return Object.keys(stats);
}

function get_data_of_s(data, s_name){
	return data["stats"][s_name]["data"];
}

/*
@param {obj} s_data - Data format
{
	2016-08-17T12:46:56+00:00: {
		account: {
			all: int_all,
			email: int_email,
			...
		},
	},
	2016-08-18T12:55:35+00:00: {
		...
	},
}
@returns {array} - Data format
[
	{
		key: "label1",
		values:[
			{ x1: val_x1, y1: val_y1},
			{ x2: val_x2, y2: val_y2},
			...
		]
	},
	{
		key: "label2",
		...
	}
]
*/

function get_formatted_data(s_data, property, ka_property){
	console.log(s_data);
	var r_values = {};
	var date_arr = Object.keys(s_data).sort();
	for(var idx = 0; idx < date_arr.length; idx++){
		var date_key = date_arr[idx];
		var attr_obj = s_data[date_key];
		console.log(date_key)
		var property_arr = Object.keys(attr_obj);
		// if property found
		if(property_arr.indexOf(property) != -1){
			var p_attr_obj = attr_obj[property];
			for(var r_key in p_attr_obj){
				if(Object.keys(r_values).indexOf(r_key) === -1){
					r_values[r_key] = [];
				}
				r_values[r_key].push({"x": date_key, "y":p_attr_obj[r_key]});
			}
		} else {

		}
	}
	
	var r_arr = [];
	for(var r_key in r_values){
		r_arr.push({"key": r_key, "values": r_values[r_key]});
	}
	return r_arr;
}


/**
DOM manipulation function with jquery
*/
function add_services(service){
	for(var idx = 0; idx < service.length; idx++){
		$(".dropdown-menu").append('<li id=dropdown-'+service[idx]+' ><a href="#">'+service[idx]+'</a></li>');
	}
}

function find_dropdown_menu_pos(){
	$dm_left = $("#service-dropdown").position();
	$("#service-dropdown-menu").css("left", $dm_left.left);
}


</script>
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.js"></script>
-->
{% endblock %}
